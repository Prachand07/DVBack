<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸš€Deploy Static Website</title>
    <link rel="stylesheet" href="S3hosting.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <div id="navbar-container"></div>
    <div class="container">
      <h1 class="title">Let's<span> Meet Cloud</span></h1>
      <div class="content">
        <div class="timeline">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-label">STEP 1</div>
              <h3 class="step-title">Upload files</h3>
              <p class="step-description">
                Got code? Drop it here to take your creation on a thrilling ride
              </p>
            </div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-label">STEP 2</div>
              <h3 class="step-title">Processing files</h3>
              <p class="step-description">
                Hang tight! Weâ€™re handling the heavy lifting behind the scenes!
              </p>
            </div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-label">STEP 3</div>
              <h3 class="step-title">Results</h3>
              <p class="step-description">
                Your results have landed !! Go ahead, take a peek!
              </p>
              <a
                id="downloadButton"
                class="download-btn"
                href="#"
                download
                style="display: none"
                >Download File</a
              >
            </div>
          </div>
        </div>

        <div class="upload-section" id="uploadSection">
          <div class="upload-box" id="uploadBox">
            <div class="input-group">
              <label for="projectName">Project Name:</label>
              <input
                type="text"
                id="projectName"
                name="projectname"
                placeholder="Enter project name"
                required
              />
            </div>
            <div class="file-icon">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
            </div>
            <div class="upload-text">Click to Upload a File</div>
            <input type="file" id="fileInput" multiple />
            <button
              class="custom-file-input"
              onclick="document.getElementById('fileInput').click()"
            >
              Choose File
            </button>
          </div>
          <div id="response"></div>
        </div>

        <div class="loading-spinner" id="loadingSpinner" style="display: none">
          <svg class="bike" viewBox="0 0 48 30" width="48px" height="30px">
            <g
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
            >
              <g transform="translate(9.5,19)">
                <circle
                  class="bike__tire"
                  r="9"
                  stroke-dasharray="56.549 56.549"
                />
                <g
                  class="bike__spokes-spin"
                  stroke-dasharray="31.416 31.416"
                  stroke-dashoffset="-23.562"
                >
                  <circle class="bike__spokes" r="5" />
                  <circle
                    class="bike__spokes"
                    r="5"
                    transform="rotate(180,0,0)"
                  />
                </g>
              </g>
              <g transform="translate(24,19)">
                <g
                  class="bike__pedals-spin"
                  stroke-dasharray="25.133 25.133"
                  stroke-dashoffset="-21.991"
                  transform="rotate(67.5,0,0)"
                >
                  <circle class="bike__pedals" r="4" />
                  <circle
                    class="bike__pedals"
                    r="4"
                    transform="rotate(180,0,0)"
                  />
                </g>
              </g>
              <g transform="translate(38.5,19)">
                <circle
                  class="bike__tire"
                  r="9"
                  stroke-dasharray="56.549 56.549"
                />
                <g
                  class="bike__spokes-spin"
                  stroke-dasharray="31.416 31.416"
                  stroke-dashoffset="-23.562"
                >
                  <circle class="bike__spokes" r="5" />
                  <circle
                    class="bike__spokes"
                    r="5"
                    transform="rotate(180,0,0)"
                  />
                </g>
              </g>
              <polyline
                class="bike__seat"
                points="14 3,18 3"
                stroke-dasharray="5 5"
              />
              <polyline
                class="bike__body"
                points="16 3,24 19,9.5 19,18 8,34 7,24 19"
                stroke-dasharray="79 79"
              />
              <path
                class="bike__handlebars"
                d="m30,2h6s1,0,1,1-1,1-1,1"
                stroke-dasharray="10 10"
              />
              <polyline
                class="bike__front"
                points="32.5 2,38.5 19"
                stroke-dasharray="19 19"
              />
            </g>
          </svg>
          <p style="color: white">Processing files... Please wait.</p>
        </div>
      </div>
    </div>
    <script src="../Backend/config.js"></script>
    <script>
      function getTokenFromCookies() {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
          const [name, value] = cookie.split("=");
          if (name === "authToken") return value;
        }
        return null;
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("Token from backend:", getTokenFromCookies());
        const ipAddress = CONFIG.PUBLIC_IP;
        const fileInput = document.getElementById("fileInput");
        const uploadSection = document.getElementById("uploadSection");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const responseDiv = document.getElementById("response");
        const steps = document.querySelectorAll(".step");
        const usernameInput = document.getElementById("username");
        const projectNameInput = document.getElementById("projectName");
        const token = getTokenFromCookies();

        const validFileTypes = [
          "image/jpeg",
          "image/png",
          "image/jpg",
          "text/html",
          "text/css",
          "text/javascript",
          "application/javascript",
          "video/mp4",
          "video/x-matroska",
          "text/csv",
        ];

        steps[0].classList.add("active");

        fileInput.addEventListener("change", async () => {
          responseDiv.innerText = "";
          responseDiv.style.color = "";

          let projectName = projectNameInput.value.trim();

          if (!projectName) {
            return Swal.fire({
              icon: "error",
              title: "Missing Project Name",
              text: "Project name is required!",
            }).then(() => {
              fileInput.value = "";
            });
          }

          const maxSize = 20 * 1024 * 1024;
          const files = fileInput.files;
          if (files.length === 0) return;

          for (let file of files) {
            if (!validFileTypes.includes(file.type)) {
              return Swal.fire({
                icon: "error",
                title: "Invalid File Type",
                text: `Invalid file type: ${file.name}`,
              });
            }

            // Size check
            if (file.size > maxSize) {
              return Swal.fire({
                icon: "error",
                title: "File Too Large",
                text: `"${file.name}" exceeds the 20MB limit.`,
              }).then(() => {
                fileInput.value = "";
              });
            }
          }

          toggleUploadSpinner(true);
          steps[0].classList.add("active");

          const formData = new FormData();
          for (const file of files) formData.append("files", file);

          formData.append("projectname", projectName);

          try {
            setTimeout(() => steps[1].classList.add("active"), 1000);

            const response = await fetch(
              `http://${ipAddress}:8090/upload-folder`,
              {
                method: "POST",
                body: formData,
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }
            );

            const result = await response.json();
            if (response.ok) {
              handleSuccess(result.message);
            } else {
              Swal.fire({
                icon: "error",
                title: "Upload Failed",
                text: result.message,
              }).then(() => {
                fileInput.value = "";
              });
              toggleUploadSpinner(false);
            }
          } catch (error) {
            console.error("Upload Error:", error);
            Swal.fire({
              icon: "error",
              title: "Network Error",
              text: "An error occurred during file upload.",
            });
          }
        });

        function displayError(message) {
          responseDiv.textContent = message;
          responseDiv.style.color = "red";
          toggleUploadSpinner(false);
        }

        function toggleUploadSpinner(isUploading) {
          uploadSection.style.display = isUploading ? "none" : "block";
          loadingSpinner.style.display = isUploading ? "block" : "none";
        }

        function handleSuccess(fileUrl) {
          let mainUrl = fileUrl.match(/http[s]?:\/\/[^\s]+/)?.[0] || fileUrl;
          steps[2].classList.add("active");
          toggleUploadSpinner(false);
          document.getElementById("uploadBox").style.display = "none";

          const blob = new Blob([fileUrl], { type: "text/plain" });
          const fileDownloadUrl = URL.createObjectURL(blob);

          responseDiv.innerHTML = `
      <div class="response-container">
        <h2 class="response-title">Your File is Ready!</h2>
        <div class="file-info">
          <input type="text" id="fileUrlInput" value="${mainUrl}" readonly>
        </div>
        <div class="action-buttons">
          <button id="copyButton" class="btn btn-primary">Copy URL</button>
          <a id="downloadButton" class="btn btn-success" href="${fileDownloadUrl}" download>Download File</a>
        </div>
        <button id="newProjectButton" class="btn btn-secondary">Start New Project</button>
      </div>
    `;

          document
            .getElementById("copyButton")
            .addEventListener("click", () => {
              const fileUrlInput = document.getElementById("fileUrlInput");
              fileUrlInput.select();
              document.execCommand("copy");
              alert("URL copied to clipboard!");
            });

          document
            .getElementById("newProjectButton")
            .addEventListener("click", () => {
              location.reload();
            });
        }

        loadingSpinner.style.display = "none";
      });

      fetch("../Frontend/Navbar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("navbar-container").innerHTML = data; // Insert navbar HTML

          // Load CSS
          let link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = "../Frontend/Navbar.css";
          document.head.appendChild(link);

          // Load JS dynamically and wait for it to finish loading
          let script = document.createElement("script");
          script.src = "../Backend/Navbar.js";
          script.onload = () => {
            if (typeof updateNavbar === "function") {
              updateNavbar(); // Call only after script loads
            } else {
              console.error(
                "updateNavbar is not defined even after script load."
              );
            }
          };
          document.body.appendChild(script);
        })
        .catch((error) => console.error("Error loading navbar:", error));
    </script>
  </body>
</html>
